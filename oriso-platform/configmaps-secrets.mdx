---
title: "Configure ConfigMaps and Secrets"
description: "Configure Kubernetes ConfigMaps and Secrets for all backend services - REQUIRED before deploying services"
---

# Configure ConfigMaps and Secrets ⭐ **REQUIRED**

**⚠️ CRITICAL**: All backend services now require ConfigMaps and Secrets. Services will **fail to start** if configuration is missing.

<Warning>
This section is **REQUIRED** before deploying backend services. Services will fail to start if configuration is missing.
</Warning>

## Understanding Configuration Management

**Key Principles:**

- ✅ **No Hardcoded Values**: All services use environment variables from ConfigMaps/Secrets
- ✅ **DNS Names**: Services use Kubernetes DNS names (e.g., `mariadb.caritas.svc.cluster.local:3306`) instead of IPs
- ✅ **Configuration Validation**: Services validate required configs on startup and fail with clear error messages
- ✅ **Update Without Rebuild**: Configuration can be updated via ConfigMaps/Secrets without rebuilding images

<Steps>
<Step title="Apply ConfigMaps and Secrets">

Apply all ConfigMaps and Secrets for backend services.

```bash
cd ~/online-beratung/caritas-workspace/ORISO-Kubernetes

# Option A: Apply all ConfigMaps and Secrets at once (recommended)
./scripts/apply-configmaps-secrets.sh

# Option B: Apply manually
kubectl apply -f configmaps/services/
kubectl apply -f secrets/services/
```

**ConfigMaps Location**: `ORISO-Kubernetes/configmaps/services/`
- `userservice-config.yaml`
- `tenantservice-config.yaml`
- `agencyservice-config.yaml`
- `consultingtypeservice-config.yaml`

**Secrets Location**: `ORISO-Kubernetes/secrets/services/`
- `userservice-secrets.yaml`
- `tenantservice-secrets.yaml`
- `agencyservice-secrets.yaml`
- `consultingtypeservice-secrets.yaml`

<Check>
All ConfigMaps and Secrets should be applied successfully without errors.
</Check>

</Step>

<Step title="Verify ConfigMaps and Secrets">

Verify that all ConfigMaps and Secrets are created in the cluster.

```bash
# Check ConfigMaps
kubectl get configmaps -n caritas | grep -E "userservice|tenantservice|agencyservice|consultingtypeservice"

# Check Secrets
kubectl get secrets -n caritas | grep -E "userservice|tenantservice|agencyservice|consultingtypeservice"

# View a ConfigMap (non-sensitive)
kubectl get configmap userservice-config -n caritas -o yaml

# View a Secret (sensitive - be careful)
kubectl get secret userservice-secrets -n caritas -o yaml
```

<Check>
You should see all four ConfigMaps and four Secrets listed:
- userservice-config, tenantservice-config, agencyservice-config, consultingtypeservice-config
- userservice-secrets, tenantservice-secrets, agencyservice-secrets, consultingtypeservice-secrets
</Check>

</Step>

<Step title="Update Deployment Files to Use ConfigMaps/Secrets">

All deployment files must reference ConfigMaps and Secrets using `envFrom`.

**Example Deployment Configuration:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: userservice
  namespace: caritas
spec:
  template:
    spec:
      containers:
      - name: userservice
        envFrom:
        - configMapRef:
            name: userservice-config
        - secretRef:
            name: userservice-secrets
```

**Verify Deployment References:**

```bash
# Check if deployment references ConfigMaps/Secrets
kubectl get deployment userservice -n caritas -o yaml | grep -A 10 envFrom

# Should show:
# envFrom:
# - configMapRef:
#     name: userservice-config
# - secretRef:
#     name: userservice-secrets
```

<Info>
**See example**: `ORISO-Kubernetes/deployments/EXAMPLE-userservice-deployment-with-configmap.yaml`
</Info>

</Step>

<Step title="Understand Configuration Validators">

All services have `ConfigurationValidator.java` that:
- ✅ Validates required environment variables on startup
- ✅ Throws clear error messages if configs are missing
- ✅ Guides you to fix missing ConfigMaps/Secrets

**Example Error (if config is missing):**

```
CRITICAL: Missing required configuration values. Please provide the following via ConfigMap/Secrets:
  - config 'spring.datasource.url (SPRING_DATASOURCE_URL)' is missing
  - config 'keycloak.auth-server-url (KEYCLOAK_AUTH_SERVER_URL)' is missing

IMPORTANT: Use Kubernetes DNS names (e.g., mariadb.caritas.svc.cluster.local:3306) NOT hardcoded IPs.
```

**If you see this error:**

1. Check ConfigMaps/Secrets are applied: `kubectl get configmaps,secrets -n caritas`
2. Verify deployment references ConfigMaps/Secrets: `kubectl get deployment <service> -n caritas -o yaml | grep -A 10 envFrom`
3. Check service logs: `kubectl logs deployment/<service> -n caritas`

</Step>

<Step title="Customize Configuration">

Update configuration values as needed for your environment.

**To update configuration values:**

```bash
# Edit ConfigMap (non-sensitive values)
kubectl edit configmap userservice-config -n caritas

# Edit Secret (sensitive values - be careful)
kubectl edit secret userservice-secrets -n caritas

# Or update the YAML files and reapply
kubectl apply -f configmaps/services/userservice-config.yaml
kubectl apply -f secrets/services/userservice-secrets.yaml

# Restart service to apply changes
kubectl rollout restart deployment/userservice -n caritas
```

**Important Notes:**

- ConfigMaps use **Kubernetes DNS names** (e.g., `mariadb.caritas.svc.cluster.local:3306`)
- Never use hardcoded IPs (e.g., `10.43.123.72:3306`) - IPs can change when pods are rescheduled
- All passwords/tokens go in Secrets, not ConfigMaps
- Update ConfigMaps/Secrets, then restart services - no need to rebuild images

<Warning>
**Never use hardcoded IPs** - Always use Kubernetes DNS names. IPs can change when pods are rescheduled, causing connection failures.
</Warning>

</Step>
</Steps>

## Configuration Structure

### ConfigMap Contents (Non-Sensitive)

ConfigMaps contain non-sensitive configuration such as:
- Database connection URLs (using DNS names)
- Service URLs
- Application properties
- Feature flags

**Example ConfigMap:**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: userservice-config
  namespace: caritas
data:
  SPRING_DATASOURCE_URL: "jdbc:mariadb://mariadb.caritas.svc.cluster.local:3306/userservice"
  KEYCLOAK_AUTH_SERVER_URL: "http://keycloak.caritas.svc.cluster.local:8080"
  SPRING_PROFILES_ACTIVE: "production"
```

### Secret Contents (Sensitive)

Secrets contain sensitive information such as:
- Database passwords
- API keys
- OAuth tokens
- Encryption keys

**Example Secret:**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: userservice-secrets
  namespace: caritas
type: Opaque
stringData:
  SPRING_DATASOURCE_PASSWORD: "your-secure-password"
  SPRING_DATASOURCE_USERNAME: "root"
```

## DNS-Based Service Discovery

All services use Kubernetes DNS names for service discovery:

| Service | DNS Name |
|---------|----------|
| MariaDB | `mariadb.caritas.svc.cluster.local:3306` |
| MongoDB | `mongodb.caritas.svc.cluster.local:27017` |
| Redis | `redis.caritas.svc.cluster.local:6379` |
| Keycloak | `keycloak.caritas.svc.cluster.local:8080` |
| RabbitMQ | `rabbitmq.caritas.svc.cluster.local:5672` |

<Info>
Kubernetes DNS automatically resolves these names to the correct service IPs, even when pods are rescheduled.
</Info>

## Troubleshooting

### Service Fails to Start with Configuration Errors

```bash
# Check service logs for ConfigurationValidator errors
kubectl logs deployment/<service-name> -n caritas --tail=100

# Look for:
# "CRITICAL: Missing required configuration values..."

# Common causes:
# 1. ConfigMaps/Secrets not applied
kubectl get configmaps,secrets -n caritas | grep <service-name>

# 2. Deployment doesn't reference ConfigMaps/Secrets
kubectl get deployment <service-name> -n caritas -o yaml | grep -A 10 envFrom

# 3. Wrong DNS names in ConfigMaps
kubectl get configmap <service-name>-config -n caritas -o yaml | grep -i "mariadb\|keycloak"

# Fix: Update ConfigMap/Secret and restart service
kubectl apply -f configmaps/services/<service-name>-config.yaml
kubectl rollout restart deployment/<service-name> -n caritas
```

### Configuration Validator Error Messages

If you see: `"CRITICAL: Missing required configuration values..."`

This means `ConfigurationValidator` found missing configs. The error message will list exactly which configs are missing.

**Solution:**

1. Check ConfigMap exists: `kubectl get configmap <service-name>-config -n caritas`
2. Check Secret exists: `kubectl get secret <service-name>-secrets -n caritas`
3. Verify values are set: `kubectl get configmap <service-name>-config -n caritas -o yaml`
4. Update ConfigMap/Secret if needed: `kubectl apply -f configmaps/services/<service-name>-config.yaml`
5. Restart service: `kubectl rollout restart deployment/<service-name> -n caritas`

## Next Steps

- [Setup Databases](/oriso-platform/setup-databases) - Ensure databases are configured
- [Deploy Backend Services](/oriso-platform/deploy-backend-services) - Deploy services that use these ConfigMaps/Secrets

