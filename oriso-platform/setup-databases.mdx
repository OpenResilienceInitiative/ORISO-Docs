---
title: "Setup Databases"
description: "Verify database pods, create MariaDB databases and schemas, and configure MongoDB"
---

# Setup Databases

Configure MariaDB and MongoDB databases for ORISO Platform services.

<Steps>
<Step title="Verify Database Pods are Running">

Ensure database pods are operational before proceeding.

```bash
# Check database pods
kubectl get pods -n caritas | grep -E "mariadb|mongodb"

# Should see:
# mariadb-xxx    1/1     Running
# mongodb-xxx    1/1     Running
```

<Check>
Both MariaDB and MongoDB pods should show status `Running` and `1/1` ready.
</Check>

</Step>

<Step title="Setup MariaDB Databases">

**⚠️ IMPORTANT**: ORISO-Database repository contains the latest production schemas exported from the running system.

**Two deployment options available:**

<Tabs>
<Tab title="Option A: Helm Chart Deployment (Recommended) ⭐ NEW">

**Benefits:**
- ✅ SQL schemas versioned with Helm chart
- ✅ Automatic schema initialization via Helm hooks
- ✅ No breaking deployments when schemas are updated
- ✅ `helm upgrade` automatically applies latest schemas
- ✅ Production-ready Helm best practices

```bash
cd ~/online-beratung/caritas-workspace/ORISO-Kubernetes/helm

# Sync latest SQL schemas from ORISO-Database to Helm chart
./sync-schemas.sh

# Install MariaDB with Helm (includes automatic schema initialization)
helm install mariadb ./charts/mariadb --namespace caritas --create-namespace

# Verify MariaDB is running
kubectl get pods -n caritas | grep mariadb

# Check init job status (applies schemas automatically)
kubectl get jobs -n caritas | grep mariadb-init
kubectl logs -n caritas job/mariadb-init-databases

# Verify databases and schemas
MARIADB_POD=$(kubectl get pods -n caritas -l app=mariadb -o jsonpath="{.items[0].metadata.name}")
kubectl exec -it -n caritas $MARIADB_POD -- mysql -u root -proot -e "SHOW DATABASES;"
```

**Updating Schemas (when ORISO-Database schemas change):**

```bash
# 1. Sync updated SQL files to Helm chart
cd ~/online-beratung/caritas-workspace/ORISO-Kubernetes/helm
./sync-schemas.sh

# 2. Upgrade Helm release (automatically applies new schemas)
helm upgrade mariadb ./charts/mariadb --namespace caritas

# 3. Verify new schemas applied
kubectl logs -n caritas job/mariadb-init-databases
```

<Info>
**See**: `ORISO-Kubernetes/helm/README.md` and `ORISO-Kubernetes/helm/HELM_GUIDE.md` for detailed Helm documentation.
</Info>

</Tab>
<Tab title="Option B: Manual Setup (Legacy)">

```bash
cd ~/online-beratung/caritas-workspace/ORISO-Database

# Run master setup script
./scripts/setup/00-master-setup.sh

# Or manual setup:

# Get MariaDB pod
MARIADB_POD=$(kubectl get pods -n caritas -l app=mariadb -o jsonpath="{.items[0].metadata.name}")

# Create databases
kubectl exec -it -n caritas $MARIADB_POD -- mysql -u root -proot <<EOF
CREATE DATABASE IF NOT EXISTS agencyservice CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS userservice CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS uploadservice CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS tenantservice CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS consultingtypeservice CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS videoservice CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS caritas CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE IF NOT EXISTS keycloak CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
SHOW DATABASES;
EOF

# Import schemas from ORISO-Database (latest production schemas)
# Note: keycloak schema is managed by Keycloak itself, not imported from ORISO-Database
for db in agencyservice userservice uploadservice tenantservice consultingtypeservice videoservice caritas; do
  echo "Importing schema for $db..."
  kubectl exec -i -n caritas $MARIADB_POD -- \
    mysql -u root -proot $db < mariadb/${db}/schema.sql
done

# Verify
kubectl exec -it -n caritas $MARIADB_POD -- \
  mysql -u root -proot -e "SHOW DATABASES;"
```

</Tab>
</Tabs>

<Check>
All required databases should be listed: agencyservice, userservice, uploadservice, tenantservice, consultingtypeservice, videoservice, caritas, keycloak
</Check>

<Note>
All schemas in `ORISO-Database/mariadb/{database}/schema.sql` are exported from the current production system and are production-ready.

**Keycloak Database**: Keycloak uses MariaDB (not a separate database). The `keycloak` database is created automatically when using Helm chart deployment (Option A), or manually when using Option B. If Keycloak is configured to use PostgreSQL instead, this database will not be present in MariaDB.
</Note>

</Step>

<Step title="Setup MongoDB">

Create MongoDB database and collections for consulting types.

```bash
# Get MongoDB pod
MONGODB_POD=$(kubectl get pods -n caritas -l app=mongodb -o jsonpath="{.items[0].metadata.name}")

# Create database and import data
kubectl exec -it -n caritas $MONGODB_POD -- mongosh <<EOF
use consulting_types
db.createCollection("consultingTypes")
exit
EOF

# Verify
kubectl exec -it -n caritas $MONGODB_POD -- \
  mongosh --eval "show dbs"
```

<Note>
If you have existing consulting types data, import it using:
```bash
kubectl cp mongodb/consulting_types/consulting-types-export.json caritas/$MONGODB_POD:/tmp/
kubectl exec -it -n caritas $MONGODB_POD -- \
  mongosh consulting_types --eval 'db.consultingTypes.insertMany([...data...])'
```
</Note>

</Step>

<Step title="Database readiness checklist">

Quick checks to ensure databases are ready before starting backend services.

1) Service and volume status

```bash
kubectl get svc,pvc -n caritas | grep -E "mariadb|mongodb"
```

2) MariaDB connectivity and schemas

```bash
# Get MariaDB pod and root password from secret
MARIADB_POD=$(kubectl get pods -n caritas -l app=mariadb -o jsonpath="{.items[0].metadata.name}")
MARIADB_ROOT_PASSWORD=$(kubectl get secret mariadb-secret -n caritas -o jsonpath="{.data.MYSQL_ROOT_PASSWORD}" | base64 -d)

# If secret doesn't exist, check deployment for hardcoded password (development only)
if [ -z "$MARIADB_ROOT_PASSWORD" ]; then
  echo "⚠️  mariadb-secret not found. Using default development password."
  MARIADB_ROOT_PASSWORD="Password1234!"
fi

# Connect as root and list databases
kubectl exec -it -n caritas $MARIADB_POD -- \
  mysql -u root -p"$MARIADB_ROOT_PASSWORD" -e "SHOW DATABASES;"

# Sample table checks (adjust as needed)
kubectl exec -it -n caritas $MARIADB_POD -- \
  mysql -u root -p"$MARIADB_ROOT_PASSWORD" -e "USE userservice; SHOW TABLES;"
kubectl exec -it -n caritas $MARIADB_POD -- \
  mysql -u root -p"$MARIADB_ROOT_PASSWORD" -e "USE tenantservice; SHOW TABLES;"

# Keycloak schema presence (if Keycloak uses MariaDB)
# Note: Keycloak may use PostgreSQL instead; this check will fail in that case
kubectl exec -it -n caritas $MARIADB_POD -- \
  mysql -u root -p"$MARIADB_ROOT_PASSWORD" -e "USE keycloak; SHOW TABLES;" 2>/dev/null || \
  echo "⚠️  Keycloak database not found in MariaDB. Keycloak may be using PostgreSQL or not yet configured."
```

3) MongoDB connectivity and collections

```bash
MONGODB_POD=$(kubectl get pods -n caritas -l app=mongodb -o jsonpath="{.items[0].metadata.name}")
kubectl exec -it -n caritas $MONGODB_POD -- mongosh --eval "show dbs"
kubectl exec -it -n caritas $MONGODB_POD -- mongosh consulting_types --eval "db.getCollectionNames()"
```

<Info>
If your deployment uses non-root DB users/secrets, verify those credentials are created and mounted in the backend deployments before proceeding.
</Info>

<Check>
MariaDB lists all required databases and tables; MongoDB lists `consulting_types` with collections. Proceed to deploy backend services.
</Check>

</Step>
</Steps>

## Export/Update Database Schemas (Optional)

If you need to export the latest schemas from a running system:

```bash
cd ~/online-beratung/caritas-workspace/ORISO-Database

# Export all schemas from running production cluster
./scripts/export-schemas.sh

# This will:
# - Export all MariaDB schemas (7 databases)
# - Export MongoDB collections
# - Export PostgreSQL schema (Matrix)
# - Update main schema files in the repository
# - Create timestamped backups in exported/ directories
```

## Related Documentation

- [Advanced Guides - Helm Charts](/oriso-platform/advanced-guides) - Detailed guide for using Helm charts with automatic schema initialization
- [ORISO-Database README](https://github.com/OpenResilienceInitiative/ORISO-Debian/blob/main/caritas-workspace/ORISO-Database/README.md) - Complete database documentation
- [Database Export Summary](https://github.com/OpenResilienceInitiative/ORISO-Debian/blob/main/caritas-workspace/ORISO-Database/EXPORT_SUMMARY.md) - Schema export information

## Next Steps

- [Configure ConfigMaps and Secrets](/oriso-platform/configmaps-secrets) ⭐ **REQUIRED** - Configure services before deployment
- [Deploy Backend Services](/oriso-platform/deploy-backend-services) - Deploy microservices that use these databases
- [Configure Keycloak](/oriso-platform/configure-keycloak) - If not already completed

